name: Build & Deploy Dashboard

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      # ğŸ” Docker login
      - name: ğŸ” Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # ğŸ›  Build dashboard Docker image
      - name: ğŸ— Build Dashboard Docker Image
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          # Create .env file for build
          echo "VITE_FIREBASE_API_KEY=$VITE_FIREBASE_API_KEY" > .env
          echo "VITE_FIREBASE_AUTH_DOMAIN=$VITE_FIREBASE_AUTH_DOMAIN" >> .env
          echo "VITE_FIREBASE_PROJECT_ID=$VITE_FIREBASE_PROJECT_ID" >> .env
          echo "VITE_FIREBASE_STORAGE_BUCKET=$VITE_FIREBASE_STORAGE_BUCKET" >> .env
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=$VITE_FIREBASE_MESSAGING_SENDER_ID" >> .env
          echo "VITE_FIREBASE_APP_ID=$VITE_FIREBASE_APP_ID" >> .env
          echo "VITE_FIREBASE_MEASUREMENT_ID=$VITE_FIREBASE_MEASUREMENT_ID" >> .env

          # Build Docker image
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/dashboard:latest .

      # ğŸš€ Push dashboard image to Docker Hub
      - name: ğŸš€ Push Dashboard Docker Image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/dashboard:latest

      # ğŸ”„ SSH into server and redeploy
      - name: ğŸ”„ SSH and Deploy on Server
        env:
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'

            set -e
            echo "ğŸ” Connected to server"

            cd /home/${{ secrets.SERVER_USER }}/mrbeas || {
              echo "âŒ Failed to cd into project directory"
              exit 1
            }

            echo "â¬‡ï¸ Pulling latest dashboard image..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/dashboard:latest || {
              echo "âŒ Failed to pull latest image"
              exit 1
            }

            echo "ğŸ” Restarting dashboard container..."
            docker-compose up -d dashboard || {
              echo "âŒ Failed to restart dashboard container"
              exit 1
            }

            # Wait for container to be healthy
            echo "â³ Waiting for dashboard to be healthy..."
            for i in {1..30}; do
              if curl -s http://localhost:80 > /dev/null; then
                echo "âœ… Dashboard is healthy!"
                exit 0
              fi
              sleep 2
            done

            echo "âŒ Dashboard failed health check"
            exit 1
          EOF
